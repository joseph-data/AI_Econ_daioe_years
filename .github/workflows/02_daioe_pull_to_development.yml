name: Pull data on daioe_pull and sync data/ to development
on:
  push:
    branches: [daioe_pull]
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Source branch to pull data from (optional)"
        required: false
      target_branch:
        description: "Target branch to update with data/ (optional)"
        required: false
  schedule:
    - cron: "0 0 * * *"  # once per day at 00:00 UTC

concurrency:
  group: data-sync-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-data:
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: ${{ github.event.inputs.source_branch || vars.SOURCE_BRANCH || 'daioe_pull' }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.SOURCE_BRANCH }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Set up uv
        uses: ./.github/actions/setup-uv
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run data scripts
        run: |
          set -euo pipefail
          uv run python scripts/main.py

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: daioe_scb_merge_output
          path: data/daioe_scb_all_levels.parquet

  sync-target:
    runs-on: ubuntu-latest
    needs: build-data
    env:
      TARGET_BRANCH: ${{ github.event.inputs.target_branch || vars.TARGET_BRANCH || 'development' }}
    steps:
      - name: Checkout target
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}

      - name: Download outputs
        uses: actions/download-artifact@v4
        with:
          name: daioe_scb_merge_output
          path: .
          merge-multiple: true

      - name: Commit and push
        run: |
          set -euo pipefail

          mkdir -p data

          found_path="$(find . -maxdepth 5 -type f -name 'daioe_scb_all_levels.parquet' -print -quit)"
          if [ -z "${found_path}" ]; then
            echo "Missing file: data/daioe_scb_all_levels.parquet"
            exit 1
          fi
          if [ "${found_path}" != "./data/daioe_scb_all_levels.parquet" ]; then
            mv "${found_path}" data/daioe_scb_all_levels.parquet
          fi

          git config user.name "joseph-data"
          git config user.email "oluochjoseph00@gmail.com"

          git add data/daioe_scb_all_levels.parquet

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update daioe_scb_all_levels.parquet"
          git push origin "${TARGET_BRANCH}"
