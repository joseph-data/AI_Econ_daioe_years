name: Pull data on scb_pull and sync data/ to daioe_pull
on:
  push:
    branches:
      - scb_pull
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Source branch to pull data from (optional)"
        required: false
      target_branch:
        description: "Target branch to update with data/ (optional)"
        required: false
  schedule:
    - cron: "0 0 * * *"  # once per day at 00:00 UTC

concurrency:
  group: data-sync-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-data:
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: ${{ github.event.inputs.source_branch || vars.SOURCE_BRANCH || 'scb_pull' }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.SOURCE_BRANCH }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - name: Install dependencies
        run: uv sync --frozen
      - name: Run data scripts
        run: |
          set -euo pipefail
          uv run python scripts/pull.py
          uv run python scripts/merge.py
          uv run python scripts/aggregate.py
      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: ssyk12-output
          path: |
            data/processed/ssyk12_aggregated_ssyk4_to_ssyk1.parquet
            logs/

  sync-target:
    runs-on: ubuntu-latest
    needs: build-data
    permissions:
      contents: write
    env:
      TARGET_BRANCH: ${{ github.event.inputs.target_branch || vars.TARGET_BRANCH || 'daioe_pull' }}
    steps:
      - name: Checkout target
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}
      - name: Download outputs
        uses: actions/download-artifact@v4
        with:
          name: ssyk12-output
      - name: Commit and push
        run: |
          set -euo pipefail

          mkdir -p data/processed

          if [ ! -f "data/processed/ssyk12_aggregated_ssyk4_to_ssyk1.parquet" ]; then
            echo "Missing combined file in artifact: data/processed/ssyk12_aggregated_ssyk4_to_ssyk1.parquet"
            exit 1
          fi

          git config user.name "joseph-data"
          git config user.email "oluochjoseph00@gmail.com"

          git add data/processed/ssyk12_aggregated_ssyk4_to_ssyk1.parquet

          # Only add logs if they exist (safe under -e)
          if [ -d "logs" ]; then
            git add logs/
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update ssyk12 aggregated data and logs"
          git push origin "${TARGET_BRANCH}"
